

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Threading and multiprocessing &mdash; System Development With Python 2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="System Development With Python 2.0 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> System Development With Python
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Threading and multiprocessing</a><ul>
<li><a class="reference internal" href="#threading-multiprocessing">Threading / multiprocessing</a><ul>
<li><a class="reference internal" href="#motivations-for-parallel-execution">Motivations for parallel execution</a></li>
<li><a class="reference internal" href="#parallelization-strategy-for-performance">Parallelization strategy for performance</a></li>
<li><a class="reference internal" href="#id1">Parallelization strategy for performance</a></li>
<li><a class="reference internal" href="#threads-versus-processes-in-python">Threads versus processes in Python</a></li>
<li><a class="reference internal" href="#id2">Processes</a></li>
<li><a class="reference internal" href="#gil">GIL</a></li>
<li><a class="reference internal" href="#posted-without-comment">Posted without comment</a></li>
<li><a class="reference internal" href="#a-cpu-bound-problem">A CPU bound problem</a></li>
<li><a class="reference internal" href="#parallel-execution-example">Parallel execution example</a></li>
<li><a class="reference internal" href="#the-threading-module">The threading module</a></li>
<li><a class="reference internal" href="#subclassing-thread">Subclassing Thread</a></li>
<li><a class="reference internal" href="#race-conditions">Race Conditions</a></li>
<li><a class="reference internal" href="#deadlocks">Deadlocks</a></li>
<li><a class="reference internal" href="#locks">Locks</a></li>
<li><a class="reference internal" href="#nonblocking-locking">Nonblocking Locking</a></li>
<li><a class="reference internal" href="#threading-rlock-reentrant-lock"><code class="docutils literal"><span class="pre">threading.RLock</span></code> - Reentrant Lock</a></li>
<li><a class="reference internal" href="#threading-semaphore"><code class="docutils literal"><span class="pre">threading.Semaphore</span></code></a></li>
<li><a class="reference internal" href="#locking-exercise">Locking Exercise</a></li>
<li><a class="reference internal" href="#managing-thread-results">Managing thread results</a></li>
<li><a class="reference internal" href="#other-queue-types">Other Queue types</a></li>
<li><a class="reference internal" href="#threading-example">Threading example</a></li>
<li><a class="reference internal" href="#threading-on-a-cpu-bound-problem">Threading on a CPU bound problem</a></li>
<li><a class="reference internal" href="#multiprocessing">Multiprocessing</a></li>
<li><a class="reference internal" href="#differences-with-threading">Differences with threading</a></li>
<li><a class="reference internal" href="#pooling">Pooling</a></li>
<li><a class="reference internal" href="#pooling-example">Pooling example</a></li>
<li><a class="reference internal" href="#threadpool">ThreadPool</a></li>
<li><a class="reference internal" href="#threading-versus-multiprocessing-networking-edition">Threading versus multiprocessing, networking edition</a></li>
<li><a class="reference internal" href="#other-options">Other options</a></li>
<li><a class="reference internal" href="#with-send-a-generator-becomes-a-coroutine">With send(), a generator becomes a coroutine</a></li>
<li><a class="reference internal" href="#packages-using-coroutines-for-micro-threads">Packages using coroutines for micro threads</a></li>
<li><a class="reference internal" href="#distributed-programming">Distributed programming</a></li>
<li><a class="reference internal" href="#celery">Celery</a></li>
<li><a class="reference internal" href="#celery-in-one-minute">Celery in one minute</a></li>
<li><a class="reference internal" href="#questions">Questions?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">System Development With Python</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Threading and multiprocessing</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/threading-multiprocessing.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="threading-and-multiprocessing">
<span id="threading"></span><h1>Threading and multiprocessing<a class="headerlink" href="#threading-and-multiprocessing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="threading-multiprocessing">
<h2>Threading / multiprocessing<a class="headerlink" href="#threading-multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>Today&#8217;s topics:</p>
<ul class="simple">
<li>Threading / multiprocessing motivation and options</li>
<li>threading module</li>
<li>multiprocessing module</li>
<li>other options</li>
</ul>
<div class="section" id="motivations-for-parallel-execution">
<h3>Motivations for parallel execution<a class="headerlink" href="#motivations-for-parallel-execution" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Performance<ul>
<li>Limited by &#8220;Amdahl&#8217;s Law&#8221;
<a class="reference external" href="http://en.wikipedia.org/wiki/Amdahl%27s_law">http://en.wikipedia.org/wiki/Amdahl%27s_law</a></li>
<li>CPUs aren&#8217;t getting much faster</li>
</ul>
</li>
<li>Event handling<ul>
<li>If a system handles asynchronous events, a seperate thread of
execution could handle those events and let other threads do other
work</li>
<li>Examples:<ul>
<li>Network applications</li>
<li>User interfaces</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Parallel programming can be hard!</p>
<p>If your problem can be solved sequentially, consider the costs and
benefits before going parallel.</p>
</div>
<div class="section" id="parallelization-strategy-for-performance">
<h3>Parallelization strategy for performance<a class="headerlink" href="#parallelization-strategy-for-performance" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">1. Break problem down into chunks</div>
<div class="line">2. Execute chunks in parallel</div>
<div class="line">3. Reassemble output of chunks into result</div>
</div>
<a class="reference internal image-reference" href="_images/OPP.0108.gif"><img alt="multitasking flow diagram" class="align-right" src="_images/OPP.0108.gif" style="height: 450px;" /></a>
</div>
<div class="section" id="id1">
<h3>Parallelization strategy for performance<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Not every problem is parallelizable</li>
<li>There is an optimal number of threads for each problem in each
environment, so make it tunable</li>
<li>Working concurrently opens up synchronization issues</li>
<li>Methods for synchronizing threads:<ul>
<li>locks</li>
<li>queues</li>
<li>signaling/messaging mechanisms</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="threads-versus-processes-in-python">
<h3>Threads versus processes in Python<a class="headerlink" href="#threads-versus-processes-in-python" title="Permalink to this headline">¶</a></h3>
<p>Threads are lightweight <a class="reference external" href="https://en.wikipedia.org/wiki/Light-weight_process">processes</a>, run in the address space of an OS
process, so a component of a a process.</p>
<p>This allows multiple threads access to data in the same scope.</p>
<p>Python threads are true OS level threads</p>
<p>Threads can not gain the performance advantage of multiple processors
due to the Global Interpreter Lock (GIL)</p>
<p>But the GIL is released during IO, allowing IO bound processes to
benefit from threading</p>
</div>
<div class="section" id="id2">
<h3>Processes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>A process contains all the instructions and data required to execute
independently, so processes do not share data!</p>
<p>Mulitple processes best to speed up CPU bound operations.</p>
<p>The Python interpreter isn&#8217;t lightweight!</p>
<p>Communication between processes can be achieved via:</p>
<p><code class="docutils literal"><span class="pre">multiprocessing.Queue</span></code></p>
<p><code class="docutils literal"><span class="pre">multiprocessing.Pipe</span></code></p>
<p>and regular IPC (inter-process communication)</p>
<p>Data moved between processes must be pickleable</p>
</div>
<div class="section" id="gil">
<h3>GIL<a class="headerlink" href="#gil" title="Permalink to this headline">¶</a></h3>
<p><strong>Global Interpreter Lock</strong></p>
<p>This is a lock which must be obtained by each thread before it can
execute, ensuring thread safety</p>
<a class="reference internal image-reference" href="_images/gil.png"><img alt="_images/gil.png" src="_images/gil.png" style="width: 100.0%;" /></a>
<p>The GIL is released during IO operations, so threads which spend time
waiting on network or disk access can enjoy performance gains</p>
<p>The GIL is not unlike multitasking in humans, some things can truly be
done in parallel, others have to be done by time slicing.</p>
<p>Note that potentially blocking or long-running operations, such as I/O, image processing, and NumPy number crunching, happen outside the GIL. Therefore it is only in multithreaded programs that spend a lot of time inside the GIL, interpreting CPython bytecode, that the GIL becomes a bottleneck. But: it can still cause performance degradation.</p>
<p>Not only will threads not help cpu-bound problems, but it can actually make things <em>worse</em>, especially on multi-core machines!</p>
<p>Some alternative Python implementations such as Jython and IronPython
have no GIL</p>
<p>cPython and PyPy have one</p>
<p>David Beazley&#8217;s talk on the gil</p>
<ul class="simple">
<li><a class="reference external" href="https://www.youtube.com/watch?v=Obt-vMVdM8s">https://www.youtube.com/watch?v=Obt-vMVdM8s</a></li>
<li><a class="reference external" href="http://wiki.python.org/moin/GlobalInterpreterLock">http://wiki.python.org/moin/GlobalInterpreterLock</a></li>
<li><a class="reference external" href="https://docs.python.org/3.5/c-api/init.html#threads">https://docs.python.org/3.5/c-api/init.html#threads</a></li>
<li><a class="reference external" href="http://hg.python.org/cpython/file/05e8dde3229c/Python/pystate.c#l761">http://hg.python.org/cpython/file/05e8dde3229c/Python/pystate.c#l761</a></li>
</ul>
</div>
<div class="section" id="posted-without-comment">
<h3>Posted without comment<a class="headerlink" href="#posted-without-comment" title="Permalink to this headline">¶</a></h3>
<div class="figure">
<img alt="_images/killGIL.jpg" class="fill" src="_images/killGIL.jpg" />
</div>
</div>
<div class="section" id="a-cpu-bound-problem">
<h3>A CPU bound problem<a class="headerlink" href="#a-cpu-bound-problem" title="Permalink to this headline">¶</a></h3>
<p>Numerically integrate the function
<span class="math">\(y =x^2\)</span> from 0 to 10.
<a class="reference external" href="http://www.wolframalpha.com/input/?i=x%5E2">http://www.wolframalpha.com/input/?i=x%5E2</a></p>
<a class="reference internal image-reference" href="_images/x2.png"><img alt="_images/x2.png" src="_images/x2.png" style="height: 400px;" /></a>
<p>Solution: <a class="reference external" href="http://www.wolframalpha.com/input/?i=int(x%5E2,0,10">http://www.wolframalpha.com/input/?i=int(x%5E2,0,10</a>)</p>
</div>
<div class="section" id="parallel-execution-example">
<h3>Parallel execution example<a class="headerlink" href="#parallel-execution-example" title="Permalink to this headline">¶</a></h3>
<p>Consider the following code from: <code class="docutils literal"><span class="pre">Examples/integrate/integrate.py</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
<p>Break down the problem into parallelizable chunks, then add the results
together:</p>
<p>We can do better than this</p>
</div>
<div class="section" id="the-threading-module">
<h3>The threading module<a class="headerlink" href="#the-threading-module" title="Permalink to this headline">¶</a></h3>
<p>Starting threads doesn&#8217;t take much:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from thread </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>The process will exit when the last non-daemon thread exits.</li>
<li>A thread can be specified as a daemon thread by setting its daemon
attribute: <code class="docutils literal"><span class="pre">thread.daemon</span> <span class="pre">=</span> <span class="pre">True</span></code></li>
<li>daemon threads get cut off at program exit, without any opportunity
for cleanup. But you don&#8217;t have to track and manage them. Useful for
things like garbage collection, network keepalives, ..</li>
<li>You can block and wait for a thread to exit with thread.join()</li>
</ul>
</div>
<div class="section" id="subclassing-thread">
<h3>Subclassing Thread<a class="headerlink" href="#subclassing-thread" title="Permalink to this headline">¶</a></h3>
<p>You can adding threading capability to your own classes</p>
<p>Subclass Thread and implement the run method</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;hello from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>

<span class="n">thread</span> <span class="o">=</span> <span class="n">MyThread</span><span class="p">()</span>
<span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="race-conditions">
<h3>Race Conditions<a class="headerlink" href="#race-conditions" title="Permalink to this headline">¶</a></h3>
<p>In the last example we saw threads competing for access to stdout.</p>
<p>Worse, if competing threads try to update the same value, we might get
an unexpected race condition</p>
<p>Race conditions occur when multiple statements need to execute
atomically, but get interrupted midway</p>
<p>See <code class="docutils literal"><span class="pre">Examples/race_condition.py</span></code></p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Thread 1</th>
<th class="head">Thread 2</th>
<th class="head">&nbsp;</th>
<th class="head">Integer value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>read value</td>
<td>&nbsp;</td>
<td>←</td>
<td>0</td>
</tr>
<tr class="row-even"><td>increase value</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>write back</td>
<td>&nbsp;</td>
<td>→</td>
<td>1</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>read value</td>
<td>←</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>increase value</td>
<td>&nbsp;</td>
<td>1</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>write back</td>
<td>→</td>
<td>2</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Thread 1</th>
<th class="head">Thread 2</th>
<th class="head">&nbsp;</th>
<th class="head">Integer value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>read value</td>
<td>&nbsp;</td>
<td>←</td>
<td>0</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>read value</td>
<td>←</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>increase value</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>0</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>increase value</td>
<td>&nbsp;</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>write back</td>
<td>&nbsp;</td>
<td>→</td>
<td>1</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>write back</td>
<td>→</td>
<td>1</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal"><span class="pre">http://en.wikipedia.org/wiki/Race_condition</span></code></p>
</div>
<div class="section" id="deadlocks">
<h3>Deadlocks<a class="headerlink" href="#deadlocks" title="Permalink to this headline">¶</a></h3>
<p>Synchronization and Critical Sections are used to control race
conditions</p>
<p>But they introduce other potential problems...</p>
<p>like: <a class="reference external" href="http://en.wikipedia.org/wiki/Deadlock">http://en.wikipedia.org/wiki/Deadlock</a></p>
<p>&#8220;A deadlock is a situation in which two or more competing actions are
each waiting for the other to finish, and thus neither ever does.&#8221;</p>
<p><em>When two trains approach each other at a crossing, both shall come to a
full stop and neither shall start up again until the other has gone</em></p>
<p>See also <em>Livelock</em>:</p>
<p><em>Two people meet in a narrow corridor, and each
tries to be polite by moving aside to let the other pass, but they end
up swaying from side to side without making any progress because they
both repeatedly move the same way at the same time.</em></p>
</div>
<div class="section" id="locks">
<h3>Locks<a class="headerlink" href="#locks" title="Permalink to this headline">¶</a></h3>
<p>Lock objects allow threads to control access to a resource until they&#8217;re
done with it</p>
<p>This is known as mutual exclusion, often called mutex</p>
<p>Python 2 has a deprecated module called mutex for this. Use a Lock
instead.</p>
<p>A Lock has two states: locked and unlocked</p>
<p>If multiple threads have access to the same Lock, they can police
themselves by calling its <code class="docutils literal"><span class="pre">.acquire()</span></code> and <code class="docutils literal"><span class="pre">.release()</span></code> methods</p>
<p>If a Lock is locked, .acquire will block until it becomes unlocked</p>
<p>These threads will wait in line politely for access to the statements in
f()</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> got lock&quot;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="nonblocking-locking">
<h3>Nonblocking Locking<a class="headerlink" href="#nonblocking-locking" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">.acquire()</span></code> will return True if it successfully acquires a lock</p>
<p>Its first argument is a boolean which specifies whether a lock should
block or not. The default is <code class="docutils literal"><span class="pre">True</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get lock&quot;</span><span class="p">)</span>
<span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;got lock&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="threading-rlock-reentrant-lock">
<h3><code class="docutils literal"><span class="pre">threading.RLock</span></code> - Reentrant Lock<a class="headerlink" href="#threading-rlock-reentrant-lock" title="Permalink to this headline">¶</a></h3>
<p>Useful for recursive algorithms, a thread-specific count of the locks is
maintained</p>
<p>A reentrant lock can be acquired multiple times by the same thread</p>
<p><code class="docutils literal"><span class="pre">Lock.release()</span></code> must be called the same number of times as <code class="docutils literal"><span class="pre">Lock.acquire()</span></code>
by that thread</p>
</div>
<div class="section" id="threading-semaphore">
<h3><code class="docutils literal"><span class="pre">threading.Semaphore</span></code><a class="headerlink" href="#threading-semaphore" title="Permalink to this headline">¶</a></h3>
<p>Like an <code class="docutils literal"><span class="pre">RLock</span></code>, but in reverse</p>
<p>A Semaphore is given an initial counter value, defaulting to 1</p>
<p>Each call to <code class="docutils literal"><span class="pre">acquire()</span></code> decrements the counter, <code class="docutils literal"><span class="pre">release()</span></code> increments it</p>
<p>If <code class="docutils literal"><span class="pre">acquire()</span></code> is called on a Semaphore with a counter of 0, it will block
until the Semaphore counter is greater than 0.</p>
<p>Useful for controlling the maximum number of threads allowed to access a
resource simultaneously</p>
<a class="reference internal image-reference" href="_images/flags.jpg"><img alt="_images/flags.jpg" src="_images/flags.jpg" style="height: 250px;" /></a>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Semaphore_(programming">http://en.wikipedia.org/wiki/Semaphore_(programming</a>)</p>
</div>
<div class="section" id="locking-exercise">
<h3>Locking Exercise<a class="headerlink" href="#locking-exercise" title="Permalink to this headline">¶</a></h3>
<p>In: <code class="docutils literal"><span class="pre">Examples/lock/stdout_writer.py</span></code></p>
<p>Multiple threads in the script write to stdout, and their output gets
jumbled</p>
<ol class="arabic simple">
<li>Add a locking mechanism to give each thread exclusive access to
stdout</li>
<li>Try adding a Semaphore to allow 2 threads access at once</li>
</ol>
</div>
<div class="section" id="managing-thread-results">
<h3>Managing thread results<a class="headerlink" href="#managing-thread-results" title="Permalink to this headline">¶</a></h3>
<p>We need a thread safe way of storing results from multiple threads of
execution. That is provided by the Queue module.</p>
<p>Queues allow multiple producers and multiple consumers to exchange data
safely</p>
<p>Size of the queue is managed with the maxsize kwarg</p>
<p>It will block consumers if empty and block producers if full</p>
<p>If maxsize is less than or equal to zero, the queue size is infinite</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">37337</span><span class="p">)</span>
<span class="n">block</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">print</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://docs.python.org/3/library/threading.html">http://docs.python.org/3/library/threading.html</a></li>
<li><a class="reference external" href="http://docs.python.org/3/library/queue.html">http://docs.python.org/3/library/queue.html</a></li>
</ul>
</div>
<div class="section" id="other-queue-types">
<h3>Other Queue types<a class="headerlink" href="#other-queue-types" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Queue.LifoQueue</span></code></p>
<blockquote>
<div><ul class="simple">
<li>Last In, First Out</li>
</ul>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">Queue.PriorityQueue</span></code></p>
<blockquote>
<div><ul class="simple">
<li>Lowest valued entries are retrieved first</li>
</ul>
</div></blockquote>
<p>One pattern for <code class="docutils literal"><span class="pre">PriorityQueue</span></code> is to insert entries of form data by
inserting the tuple:</p>
<p><code class="docutils literal"><span class="pre">(priority_number,</span> <span class="pre">data)</span></code></p>
</div>
<div class="section" id="threading-example">
<h3>Threading example<a class="headerlink" href="#threading-example" title="Permalink to this headline">¶</a></h3>
<p>See Examples/threading/integrate_main.py</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">Queue</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">integrate.integrate</span> <span class="kn">import</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">decorators.decorators</span> <span class="kn">import</span> <span class="n">timer</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@timer</span>
<span class="k">def</span> <span class="nf">threading_integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">thread_count</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;break work into two chunks&quot;&quot;&quot;</span>
    <span class="n">N_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">thread_count</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">thread_count</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">integrate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">thread_count</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">i</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">N_chunk</span><span class="p">))</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">print</span> <span class="s2">&quot;Thread </span><span class="si">%s</span><span class="s2"> started&quot;</span> <span class="o">%</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># thread1.join()</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">thread_count</span><span class="p">)</span> <span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;integrator&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;thread_count&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">b</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">N</span>
    <span class="n">thread_count</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">thread_count</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Numerical solution with N=</span><span class="si">%(N)d</span><span class="s2"> : </span><span class="si">%(x)f</span><span class="s2">&quot;</span> <span class="o">%</span> \
            <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">threading_integrate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">thread_count</span><span class="o">=</span><span class="n">thread_count</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="section" id="threading-on-a-cpu-bound-problem">
<h3>Threading on a CPU bound problem<a class="headerlink" href="#threading-on-a-cpu-bound-problem" title="Permalink to this headline">¶</a></h3>
<p>Try running the code in examples/threading/integrate_main.py</p>
<p>It accepts 4 arguments:</p>
<p><code class="docutils literal"><span class="pre">./integrate_main.py</span> <span class="pre">0</span> <span class="pre">10</span> <span class="pre">1000000</span> <span class="pre">4</span></code></p>
<p>What happens when you change the thread count? What thread count gives
the maximum speed?</p>
</div>
<div class="section" id="multiprocessing">
<h3>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h3>
<p>multiprocessing provides an API very similar to threading, so the
transition is easy</p>
<p>use <code class="docutils literal"><span class="pre">multiprocessing.Process</span></code> instead of <code class="docutils literal"><span class="pre">threading.Thread</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;hello from process </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">proc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">proc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="differences-with-threading">
<h3>Differences with threading<a class="headerlink" href="#differences-with-threading" title="Permalink to this headline">¶</a></h3>
<p>Multiprocessing has its own <code class="docutils literal"><span class="pre">multiprocessing.Queue</span></code> which handles
interprocess communication</p>
<p>Also has its own versions of <code class="docutils literal"><span class="pre">Lock</span></code>, <code class="docutils literal"><span class="pre">RLock</span></code>, <code class="docutils literal"><span class="pre">Semaphore</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Lock</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">multiprocessing.Pipe</span></code> for 2-way process communication:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pipe</span>
<span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
<span class="n">child_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">parent_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="pooling">
<h3>Pooling<a class="headerlink" href="#pooling" title="Permalink to this headline">¶</a></h3>
<p>A processing pool contains worker processes with only a configured
number running at one time</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>The Pool module has several methods for adding jobs to the pool</p>
<p><code class="docutils literal"><span class="pre">apply_async(func[,</span> <span class="pre">args[,</span> <span class="pre">kwargs[,</span> <span class="pre">callback]]])</span></code></p>
<p><code class="docutils literal"><span class="pre">map_async(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize[,</span> <span class="pre">callback]])</span></code></p>
</div>
<div class="section" id="pooling-example">
<h3>Pooling example<a class="headerlink" href="#pooling-example" title="Permalink to this headline">¶</a></h3>
<div class="small highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p class="small"><a class="reference external" href="http://docs.python.org/3/library/multiprocessing.html#module-multiprocessing.pool">http://docs.python.org/3/library/multiprocessing.html#module-multiprocessing.pool</a></p>
</div>
<div class="section" id="threadpool">
<h3>ThreadPool<a class="headerlink" href="#threadpool" title="Permalink to this headline">¶</a></h3>
<p>Threading also has a pool</p>
<p>Confusingly, it lives in the multiprocessing module</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="k">import</span> <span class="n">ThreadPool</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="threading-versus-multiprocessing-networking-edition">
<h3>Threading versus multiprocessing, networking edition<a class="headerlink" href="#threading-versus-multiprocessing-networking-edition" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;re going to test making concurrent connections to a web service in:</p>
<p><code class="docutils literal"><span class="pre">Examples/server/app.py</span></code></p>
<p>It is a WSGI application which can be run with Green Unicorn or another
WSGI server</p>
<p><code class="docutils literal"><span class="pre">$</span> <span class="pre">gunicorn</span> <span class="pre">app:app</span> <span class="pre">--bind</span> <span class="pre">0.0.0.0:37337</span></code></p>
<p><code class="docutils literal"><span class="pre">client-threading.py</span></code> makes 100 threads to contact the web service</p>
<p><code class="docutils literal"><span class="pre">client-mp.py</span></code> makes 100 processes to contact the web service</p>
<p><code class="docutils literal"><span class="pre">client-pooled.py</span></code> creates a ThreadPool</p>
<p><code class="docutils literal"><span class="pre">client-pooled.py</span></code> contains a results Queue, but doesn&#8217;t use it. Can you
collect all the output from the pool into a single data structure using
this Queue?</p>
</div>
<div class="section" id="other-options">
<h3>Other options<a class="headerlink" href="#other-options" title="Permalink to this headline">¶</a></h3>
<p>Traditionally, concurency has been achieved through multiple process
communication and in-process threads, as we&#8217;ve seen</p>
<p>Another strategy is through micro-threads, implemented via coroutines
and a scheduler</p>
<p>A coroutine is a generalization of a subroutine which allows multiple
entry points for suspending and resuming execution</p>
<p>The threading and the multiprocessing modules follow a <a href="#id3"><span class="problematic" id="id4">`</span></a>preemptive
multitasking model: <a class="reference external" href="http://en.wikipedia.org/wiki/Preemption_(computing">http://en.wikipedia.org/wiki/Preemption_(computing</a>)</p>
<p>Coroutine based solutions follow a <a class="reference external" href="http://en.wikipedia.org/wiki/Computer_multitasking#Cooperative_multitasking.2Ftime-sharing">cooperative multitasking
model</a></p>
<p>A Curious Course on Coroutines and Concurrency</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://dabeaz.com/coroutines/">http://dabeaz.com/coroutines/</a></li>
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Coroutine">http://en.wikipedia.org/wiki/Coroutine</a></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="with-send-a-generator-becomes-a-coroutine">
<h3>With send(), a generator becomes a coroutine<a class="headerlink" href="#with-send-a-generator-becomes-a-coroutine" title="Permalink to this headline">¶</a></h3>
<div class="small highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
 <span class="n">coroutine</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
 <span class="n">coroutine</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
 <span class="n">coroutine</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
    <span class="n">target</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p class="small"><a class="reference external" href="http://dabeaz.com/coroutines/Coroutines.pdf">http://dabeaz.com/coroutines/Coroutines.pdf</a></p>
</div>
<div class="section" id="packages-using-coroutines-for-micro-threads">
<h3>Packages using coroutines for micro threads<a class="headerlink" href="#packages-using-coroutines-for-micro-threads" title="Permalink to this headline">¶</a></h3>
<p>By &#8220;jumping&#8221; to parallel coroutines, our application can simulate true
threads.</p>
<p>Creating the scheduler which does the jumping is an exercise for the
reader, but look into these packages which handle the dirty work</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.python.org/pypi/greenlet">https://pypi.python.org/pypi/greenlet</a></li>
</ul>
<blockquote>
<div><ul class="simple">
<li>interface for creating coroutine based microthreads</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><a class="reference external" href="http://eventlet.net/">http://eventlet.net/</a></li>
</ul>
<blockquote>
<div><ul class="simple">
<li>a concurrent networking library, based on
greenlet. Developed for Second Life</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><a class="reference external" href="http://www.gevent.org">http://www.gevent.org</a></li>
</ul>
<blockquote>
<div><ul class="simple">
<li>forked from eventlet. Built on top of greenlet and libevent,
a portable event loop with strong OS support</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Python 3.4+ : the asyncio module</li>
</ul>
</div>
<div class="section" id="distributed-programming">
<h3>Distributed programming<a class="headerlink" href="#distributed-programming" title="Permalink to this headline">¶</a></h3>
<p>A distributed system is one in which components located on networked
computers communicate and coordinate their actions by passing messages</p>
<p>There are lots of ways to do this at different layers. MPI, *-RPC,
Pyro, ...</p>
</div>
<div class="section" id="celery">
<h3>Celery<a class="headerlink" href="#celery" title="Permalink to this headline">¶</a></h3>
<p>&#8220;Celery is an asynchronous task queue/job queue based on distributed
message passing&#8221;</p>
<p>Provides an API for defining tasks, and retrieving results from those
tasks</p>
<p>Messages are passed via a &#8220;message broker&#8221;, of which Celery supports
several:</p>
<ul class="simple">
<li>RabbitMQ (default)</li>
<li>Redis</li>
<li>MongoDB</li>
<li>Amazon SQS</li>
<li>...</li>
</ul>
<p>Celery worker processes are run on compute nodes, while the main process
farms jobs out to them:</p>
<p><a class="reference external" href="http://www.celeryproject.org/">http://www.celeryproject.org/</a></p>
</div>
<div class="section" id="celery-in-one-minute">
<h3>Celery in one minute<a class="headerlink" href="#celery-in-one-minute" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># tasks.py</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;amqp&quot;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://guest@localhost//&#39;</span><span class="p">)</span>

<span class="nd">@celery.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="o">%</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">tasks</span> <span class="n">worker</span> <span class="o">--</span><span class="n">loglevel</span><span class="o">=</span><span class="n">INFO</span> <span class="o">-</span><span class="n">c</span> <span class="mi">4</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="questions">
<h3>Questions?<a class="headerlink" href="#questions" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Christopher Barker, Joseph Sheedy, Maria McKinley.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>